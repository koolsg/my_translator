<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Local Translator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            background-color: #f5f5f7;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 15px;
            border-bottom: 1px solid #dcdcdc;
            background-color: #ffffff;
        }
        select, #translate-button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #dcdcdc;
            font-family: inherit;
            background-color: #ffffff;
            color: #333333;
            cursor: pointer;
        }
        select:hover {
            border-color: #007aff;
        }
        select:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1);
        }
        #translate-button {
            border: none;
            background-color: #007aff;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #translate-button:hover {
            background-color: #005ec4;
        }
        #translate-button:disabled {
            background-color: #a0c8ff;
            cursor: not-allowed;
        }
        .translator-container {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            gap: 20px;
            height: calc(100vh - 100px); /* 헤더 높이 고려 */
        }
        .text-area {
            width: 100%;
            height: 100%;
            padding: 15px;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            font-size: 18px;
            background-color: #ffffff;
            resize: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }
        .text-area:disabled {
            background-color: #e9e9eb;
        }
        #output-text {
            background-color: #f5f5f7;
            border: 1px solid #e5e5e5;
            white-space: pre-wrap; /* 줄바꿈 유지를 위해 */
            overflow-y: auto;
        }
        .char-counter {
            position: absolute;
            top: 10px;
            right: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            pointer-events: none;
        }
        .input-section, .output-section {
            flex: 1;
            height: 100%;
            position: relative;
        }
    </style>
</head>
<body>

    <div class="header">
        <select id="provider-select">
            <option value="gemini">Gemini</option>
            <option value="openai">OpenAI</option>
        </select>
        <select id="model-select">
            <!-- 선택된 Provider에 맞는 모델 목록이 동적으로 채워집니다 -->
        </select>
        <select id="target-language-select">
            <option value="ko">한국어</option>
            <option value="en">영어</option>
            <option value="ja">일본어</option>
            <option value="zh">중국어</option>
        </select>
        <button id="translate-button">번역하기</button>
        <div style="display: flex; align-items: center; gap: 5px; margin-left: 15px;">
            <input type="checkbox" id="notification-checkbox" checked>
            <label for="notification-checkbox" style="font-size: 14px; color: #333; cursor: pointer;">Windows 알림</label>
        </div>
    </div>

    <div class="translator-container">
        <div class="input-section">
            <textarea id="input-text" class="text-area" placeholder="번역할 내용을 입력하세요..."></textarea>
            <div id="char-counter" class="char-counter">글자: 0</div>
        </div>
        <div class="output-section">
            <div id="output-text" class="text-area"></div>
        </div>
    </div>

    <script>
        // 글자 수 카운터 업데이트 함수
        function updateCharCounter() {
            const inputText = document.getElementById('input-text').value;
            const charCounter = document.getElementById('char-counter');
            charCounter.textContent = `글자: ${inputText.length}`;
        }

        // 선택된 provider에 맞는 모델 목록을 가져오는 함수
        async function loadModelsForProvider(provider, selectedModelName = null) {
            const modelSelect = document.getElementById('model-select');
            modelSelect.innerHTML = '<option>모델 로딩 중...</option>';

            try {
                const response = await fetch(`http://localhost:5000/models?provider=${provider}`);
                if (!response.ok) {
                    throw new Error('모델 목록을 불러오는 데 실패했습니다.');
                }
                const models = await response.json();

                modelSelect.innerHTML = ''; // 기존 옵션 삭제
                if (models.length === 0) {
                    modelSelect.innerHTML = '<option>사용 가능한 모델 없음</option>';
                    return;
                }

                models.forEach(modelName => {
                    const option = document.createElement('option');
                    option.value = modelName;
                    // 모델 이름에서 'models/' 부분을 정리하여 보여주기
                    let displayName = modelName.replace('models/', '');
                    option.textContent = displayName;
                    modelSelect.appendChild(option);
                });

                // 불러온 후, 이전에 선택했던 모델이 있으면 선택
                if (selectedModelName) {
                    modelSelect.value = selectedModelName;
                }

            } catch (error) {
                console.error('Error fetching models:', error);
                modelSelect.innerHTML = '<option>모델 로딩 실패</option>';
            }
        }

        // 페이지 로드 시 초기화
        window.addEventListener('DOMContentLoaded', () => {
            // 글자 수 카운터 초기화 및 이벤트 리스너 추가
            updateCharCounter();
            document.getElementById('input-text').addEventListener('input', updateCharCounter);

            const providerSelect = document.getElementById('provider-select');
            const lastUsedProvider = localStorage.getItem('lastUsedProvider') || 'gemini';
            const lastUsedModel = localStorage.getItem('lastUsedModel');

            // 마지막으로 사용한 provider를 선택
            providerSelect.value = lastUsedProvider;

            // API Provider 변경 시 모델 목록 업데이트
            providerSelect.addEventListener('change', (e) => {
                loadModelsForProvider(e.target.value);
            });

            // 초기 모델 목록 로드 (마지막으로 사용한 provider와 model 기준)
            loadModelsForProvider(lastUsedProvider, lastUsedModel);
        });

        // 번역 버튼 클릭 이벤트 리스너
        document.getElementById('translate-button').addEventListener('click', () => {
            const inputText = document.getElementById('input-text').value;
            const outputDiv = document.getElementById('output-text');
            const providerSelect = document.getElementById('provider-select');
            const selectedProvider = providerSelect.value;
            const selectedModel = document.getElementById('model-select').value;
            const targetLanguage = document.getElementById('target-language-select').value;
            const showNotification = document.getElementById('notification-checkbox').checked;

            const translateButton = document.getElementById('translate-button');
            const inputTextarea = document.getElementById('input-text');

            if (!inputText.trim()) {
                outputDiv.textContent = '번역할 내용을 입력해주세요.';
                return;
            }

            if (!selectedModel || selectedModel.includes('로딩') || selectedModel.includes('없음')) {
                outputDiv.textContent = '먼저 사용 가능한 모델을 선택해주세요.';
                return;
            }

            // UI 비활성화
            translateButton.disabled = true;
            inputTextarea.disabled = true;

            // 타이머 시작
            let startTime = Date.now();
            let timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeString = minutes > 0 ? `${minutes}분 ${seconds}초` : `${seconds}초`;
                outputDiv.textContent = `번역 중... (${timeString} 경과)`;
            }, 1000);

            outputDiv.textContent = '번역 중... (0초 경과)';

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000);

            fetch('http://localhost:5000/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: inputText,
                    model: selectedModel,
                    target_language: targetLanguage,
                    show_notification: showNotification
                }),
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || '서버에서 오류가 발생했습니다.');
                    });
                }
                return response.json();
            })
            .then(data => {
                outputDiv.textContent = data.translated_text;
                // 번역 성공 시 마지막으로 사용한 provider와 model 저장
                localStorage.setItem('lastUsedProvider', selectedProvider);
                localStorage.setItem('lastUsedModel', selectedModel);
            })
            .catch(error => {
                console.error('Error:', error);
                outputDiv.textContent = `번역 중 오류가 발생했습니다: ${error.message}`;
            })
            .finally(() => {
                clearInterval(timerInterval);
                translateButton.disabled = false;
                inputTextarea.disabled = false;
            });
        });
    </script>

</body>
</html>
